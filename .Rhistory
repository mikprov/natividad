geom_abline(slope=0,intercept = 0,color="grey",linetype='dashed')
}
p[[1]]
p[[14]]
p <- as.list(rep(NA,length=length(site_vector)))
for(s in 1:length(site_vector)){
d <- bottomall_stress[bottomall_stress$Site == site_vector[s],]
p[[s]] <- ggplot(data=d) +
geom_point(aes(x=Date,y=Dstress,color=Temperature_20)) +
scale_color_viridis(begin = 0,end = 1) +
geom_line(aes(x=Date,y=Dstress,color=Temperature_20)) +
ggtitle(paste(site_vector[s])) +
ylab("Expected T - Experienced T") + xlab("date") +
ylim(-2,2) +
theme_bw() +
geom_abline(slope=0,intercept = 0,color="grey",linetype='dashed')
}
p[[1]]
p[[14]]
p[[9]]
p[[14]]
p[[9]]
rm(list=ls())
library(ggplot2)
library(grid)
library(gridExtra)
library(cowplot)
library(ggrepel)
library(pracma)
library(viridis)
library(lemon)
library(lubridate)
library(zoo)
library(tidyverse)
library(stats)
library(sf)
library(viridis)
# load functions --> ***** CHECK for MG or MP *****
source("C:/Users/Mikaela/Documents/GitHub/natividad/functions.r")
d <- read.csv(file="C:/Users/Mikaela/Documents/GitHub/natividad/data/001_FEDECOOP_MS_DATA.csv",stringsAsFactors = FALSE)
d$Date <- as.Date(d$UTC_DateTime,format="%Y-%m-%d") # create date-only column
bottomall <- d %>%
group_by(Site,Date) %>%
sample_n(1) %>%
select(Site,Temperature,Date)# randomly select temp per day
#names(bottomall)[names(bottomall)=="Temperature"] <- "temp_bottom"
rm(d)
site_vector <- unique(bottomall$Site)
# -------------------------------------------
# Method 1: area under short-term variability curve
# -------------------------------------------
wts <- c(0.1,0.2,0.4,0.8)
wts <- wts/sum(wts)
wtsp <- round(wts*100,digits=0)
auc_method1 <- data.frame(
Site = site_vector,
area_method1 = rep(NA,length=length(site_vector)))
stress_list <- as.list(rep(NA,length=length(site_vector)))
names(stress_list) <- site_vector
for(s in 1:length(site_vector)){
stress_list[[s]] <- calc_stress(d=bottomall[bottomall$Site==site_vector[s],],
weights=wtsp)
stress <- stress_list[[s]]
yy <- abs(stress[stress$Site==site_vector[s],]$Dstress)
yy <- yy[!is.na(yy)]
xx <- seq(from=1,to=length(yy),by=1)
auc_method1[auc_method1$Site == site_vector[s],]$area_method1 <- trapz(x=xx,y=yy)
rm(yy,xx,stress)
}
bottomall_stress <- do.call("rbind",stress_list)
# -------------------------------------------
# Method 2: area under temperature curve for when temp is >20C
# -------------------------------------------
auc_method2 <- data.frame(
Site = site_vector,
area_method2 = rep(NA,length=length(site_vector)))
bottomall_stress$Temperature_20 <- ifelse(bottomall_stress$Temperature < 20,0,bottomall_stress$Temperature)
for(s in 1:length(site_vector)){
d <- bottomall_stress[bottomall_stress$Site==site_vector[s],]
xx <- seq(from=1,to=length(d$Temperature),by=1)
auc_method2[auc_method2$Site == site_vector[s],]$area_method2 <- (trapz(x=xx,y=d$Temperature_20))#/(length(d$Temperature_20>0))
}
p <- as.list(rep(NA,length=length(site_vector)))
for(s in 1:length(site_vector)){
d <- bottomall_stress[bottomall_stress$Site == site_vector[s],]
p[[s]] <- ggplot(data=d) +
geom_point(aes(x=Date,y=Dstress,color=Temperature_20)) +
scale_color_viridis(begin = 0,end = 1) +
geom_line(aes(x=Date,y=Dstress,color=Temperature_20)) +
ggtitle(paste(site_vector[s])) +
ylab("Expected T - Experienced T") + xlab("date") +
ylim(-2,2) +
theme_bw() +
geom_abline(slope=0,intercept = 0,color="grey",linetype='dashed')
}
# get the shapefile
f <- st_read("C:/Users/Mikaela/Documents/GitHub/natividad/shapefiles/FEDECOOP.shp")
s <- st_read("C:/Users/Mikaela/Documents/GitHub/natividad/shapefiles/countries.shp")
locations <- read.csv("C:/Users/Mikaela/Documents/GitHub/natividad/data/Sensor_Locations_map.csv")
names(locations)[1] <- "Site"
locations <- left_join(locations,auc_method1,by='Site')
locations <- left_join(locations,auc_method2,by='Site')
ggplot() +
geom_sf(data=s) +
geom_sf(data=f,col='grey60',fill='grey',alpha=0.3) +
coord_sf(ylim=c(26,29), xlim=c(-116,-112.5)) +
geom_point(data=locations,aes(x=Longtitude,y=Latitude,color=area_method1),size=5) +
scale_color_viridis(direction = -1) +
geom_text_repel(data=locations[!locations$Site %in% c('Monterey','VanDamme','Sportfish','LaJolla'),],
aes(x=Longtitude, y=Latitude,label = Site,color=area_method1),
segment.color = "grey30",
size = 4,
na.rm = TRUE,
nudge_x = -0.2,
box.padding = 1) +
theme_bw() + xlab("") +ylab("")
p <- as.list(rep(NA,length=length(site_vector)))
for(s in 1:length(site_vector)){
d <- bottomall[bottomall$Site == site_vector[s],]
p[[s]] <- ggplot(data=d) +
#geom_point(aes(x=Date,y=Temperature)) +
geom_line(aes(x=Date,y=Temperature)) +
ggtitle(paste(site_vector[s])) +
ylab("temp") + xlab("date") +
ylim(8,27) +
theme_bw() +
geom_abline(slope=0,intercept = 20,color="red",linetype='dashed')
}
ggplot() +
geom_sf(data=s) +
geom_sf(data=f,col='grey60',fill='grey',alpha=0.3) +
coord_sf(ylim=c(26,29), xlim=c(-116,-112.5)) +
geom_point(data=locations,aes(x=Longtitude,y=Latitude,color=area_method2),size=5) +
scale_color_viridis(direction = -1) +
geom_text_repel(data=locations[!locations$Site %in% c('Monterey','VanDamme','Sportfish','LaJolla'),],
aes(x=Longtitude, y=Latitude,label = Site,color=area_method2),
segment.color = "grey30",
size = 4,
na.rm = TRUE,
nudge_x = -0.2,
box.padding = 1) +
theme_bw() + xlab("") +ylab("")
ggplot() +
geom_sf(data=s) +
geom_sf(data=f,col='grey60',fill='grey',alpha=0.3) +
coord_sf(ylim=c(26,29), xlim=c(-116,-112.5))
ggplot() +
geom_sf(data=s) +
geom_sf(data=f,col='grey60',fill='grey',alpha=0.3)
f <- st_read("C:/Users/Mikaela/Documents/GitHub/natividad/shapefiles/FEDECOOP.shp")
s <- st_read("C:/Users/Mikaela/Documents/GitHub/natividad/shapefiles/countries.shp")
ggplot() +
geom_sf(data=s) +
geom_sf(data=f,col='grey60',fill='grey',alpha=0.3) +
coord_sf(ylim=c(26,29), xlim=c(-116,-112.5))
ggplot() +
geom_sf(data=s) +
geom_sf(data=f,col='grey60',fill='grey',alpha=0.3) +
coord_sf(ylim=c(26,29), xlim=c(-116,-112.5)) +
geom_point(data=locations,aes(x=Longtitude,y=Latitude,color=area_method2),size=5) +
scale_color_viridis(direction = 1)
ggplot() +
geom_sf(data=s) +
geom_sf(data=f,col='grey60',fill='grey',alpha=0.3) +
coord_sf(ylim=c(26,29), xlim=c(-116,-112.5)) +
geom_point(data=locations,aes(x=Longtitude,y=Latitude,color=area_method2),size=5) +
scale_color_viridis(direction = 1) +
geom_text_repel(data=locations[!locations$Site %in% c('Monterey','VanDamme','Sportfish','LaJolla'),],
aes(x=Longtitude, y=Latitude,label = Site,color=area_method2),
segment.color = "grey30",
size = 4,
na.rm = TRUE,
nudge_x = -0.2,
box.padding = 1) +
theme_bw() + xlab("") +ylab("")
rm(list=ls())
s=1
d <- bottomall_stress[bottomall_stress$Site==site_vector[s],]
library(ggplot2)
library(grid)
library(gridExtra)
library(cowplot)
library(ggrepel)
library(pracma)
library(viridis)
library(lemon)
library(lubridate)
library(zoo)
library(tidyverse)
library(stats)
library(sf)
library(viridis)
# load functions --> ***** CHECK for MG or MP *****
source("C:/Users/Mikaela/Documents/GitHub/natividad/functions.r")
d <- read.csv(file="C:/Users/Mikaela/Documents/GitHub/natividad/data/001_FEDECOOP_MS_DATA.csv",stringsAsFactors = FALSE)
d$Date <- as.Date(d$UTC_DateTime,format="%Y-%m-%d") # create date-only column
bottomall <- d %>%
group_by(Site,Date) %>%
sample_n(1) %>%
select(Site,Temperature,Date)# randomly select temp per day
#names(bottomall)[names(bottomall)=="Temperature"] <- "temp_bottom"
rm(d)
site_vector <- unique(bottomall$Site)
# -------------------------------------------
# Method 1: area under short-term variability curve
# -------------------------------------------
wts <- c(0.1,0.2,0.4,0.8)
wts <- wts/sum(wts)
wtsp <- round(wts*100,digits=0)
auc_method1 <- data.frame(
Site = site_vector,
area_method1 = rep(NA,length=length(site_vector)))
stress_list <- as.list(rep(NA,length=length(site_vector)))
names(stress_list) <- site_vector
for(s in 1:length(site_vector)){
stress_list[[s]] <- calc_stress(d=bottomall[bottomall$Site==site_vector[s],],
weights=wtsp)
stress <- stress_list[[s]]
yy <- abs(stress[stress$Site==site_vector[s],]$Dstress)
yy <- yy[!is.na(yy)]
xx <- seq(from=1,to=length(yy),by=1)
auc_method1[auc_method1$Site == site_vector[s],]$area_method1 <- trapz(x=xx,y=yy)
rm(yy,xx,stress)
}
bottomall_stress <- do.call("rbind",stress_list)
s
s=1
d <- bottomall_stress[bottomall_stress$Site==site_vector[s],]
head(d)
# how many weeks are there?
length(d[,1])/7
# how many weeks are there?
floor(length(d[,1])/7)
# -------------------------------------------
# Method 3: degree heating week
# -------------------------------------------
# for each week, sum temperature that is >20 C
# plot these time series for each site
dhw <- as.list(rep(NA,length=length(site_vector)))
names(dhw) <- site_vector
# how many weeks are there? rounding down
df <- data.frame(weeknum = seq(from=1,to=floor(length(d[,1])/7),by=1),
weekdate = rep(NA,length=floor(length(d[,1])/7)))
df
head(d)
bottomall_stress$Temperature_20 <- ifelse(bottomall_stress$Temperature < 20,0,bottomall_stress$Temperature)
length(df$weeknum)
i=1
# subset temp data to window
tsub <- d[i:(i+7-1),]
tsub
d <- bottomall_stress[bottomall_stress$Site==site_vector[s],]
# subset temp data to window
tsub <- d[i:(i+7-1),]
tsub
d$Date[7]
d$Date[7*floor(length(d[,1])/7)]
tail(d)
# how many weeks are there? rounding down
df <- data.frame(weeknum = seq(from=1,to=floor(length(d[,1])/7),by=1),
enddate = seq(from=d$Date[7],to=d$Date[7*floor(length(d[,1])/7)],by=7),
weekdate = rep(NA,length=floor(length(d[,1])/7)))
df
# how many weeks are there? rounding down
df <- data.frame(weeknum = seq(from=1,to=floor(length(d[,1])/7),by=1),
startdate = seq(from=d$Date[1],to=d$Date[7*floor(length(d[,1])/7)-6],by=7),
enddate = seq(from=d$Date[7],to=d$Date[7*floor(length(d[,1])/7)],by=7),
weekdate = rep(NA,length=floor(length(d[,1])/7)))
df
# how many weeks are there? rounding down
df <- data.frame(weeknum = seq(from=1,to=floor(length(d[,1])/7),by=1),
startdate = seq(from=d$Date[1],to=d$Date[7*floor(length(d[,1])/7)-6],by=7),
enddate = seq(from=d$Date[7],to=d$Date[7*floor(length(d[,1])/7)],by=7),
dhw = rep(NA,length=floor(length(d[,1])/7))  )
head(df)
# how many weeks are there? rounding down
df <- data.frame(site = rep(site_vector[s],length=floor(length(d[,1])/7)),
weeknum = seq(from=1,to=floor(length(d[,1])/7),by=1),
startdate = seq(from=d$Date[1],to=d$Date[7*floor(length(d[,1])/7)-6],by=7),
enddate = seq(from=d$Date[7],to=d$Date[7*floor(length(d[,1])/7)],by=7),
dhw = rep(NA,length=floor(length(d[,1])/7))  )
head(df)
i
# subset temp data to window
tsub <- d[d$Date > df$startdate[i] & d$Date < df$enddate[i],]
tsub
# subset temp data to window
tsub <- d[d$Date >= df$startdate[i] & d$Date =< df$enddate[i],]
# subset temp data to window
tsub <- d[d$Date >= df$startdate[i] & d$Date <= df$enddate[i],]
tsub
i=2
# subset temp data to window
tsub <- d[d$Date >= df$startdate[i] & d$Date <= df$enddate[i],]
tsub
# -------------------------------------------
# Method 3: degree heating week
# -------------------------------------------
# for each week, sum temperature that is >20 C
# plot these time series for each site
dhwL <- as.list(rep(NA,length=length(site_vector)))
names(dhwL) <- site_vector
for(s in 1:length(site_vector)){
d <- bottomall_stress[bottomall_stress$Site==site_vector[s],]
# how many weeks are there? rounding down
df <- data.frame(site = rep(site_vector[s],length=floor(length(d[,1])/7)),
weeknum = seq(from=1,to=floor(length(d[,1])/7),by=1),
startdate = seq(from=d$Date[1],to=d$Date[7*floor(length(d[,1])/7)-6],by=7),
enddate = seq(from=d$Date[7],to=d$Date[7*floor(length(d[,1])/7)],by=7),
dhw = rep(NA,length=floor(length(d[,1])/7))  )
for(i in 1:length(df$weeknum)){ #step through dates
# subset temp data to window
tsub <- d[d$Date >= df$startdate[i] & d$Date <= df$enddate[i],]
df$dhw[i] <- sum(tsub$Temperature_20)
}
dhwL[[s]] <- df
}
rm(d,s,df,tsub)
s=1
s=3
d <- bottomall_stress[bottomall_stress$Site==site_vector[s],]
# how many weeks are there? rounding down
df <- data.frame(site = rep(site_vector[s],length=floor(length(d[,1])/7)),
weeknum = seq(from=1,to=floor(length(d[,1])/7),by=1),
startdate = seq(from=d$Date[1],to=d$Date[7*floor(length(d[,1])/7)-6],by=7),
enddate = seq(from=d$Date[7],to=d$Date[7*floor(length(d[,1])/7)],by=7),
dhw = rep(NA,length=floor(length(d[,1])/7))  )
floor(length(d[,1])/7)
summary(df)
for(i in 1:length(df$weeknum)){ #step through dates
# subset temp data to window
tsub <- d[d$Date >= df$startdate[i] & d$Date <= df$enddate[i],]
df$dhw[i] <- sum(tsub$Temperature_20)
}
head(df)
dhwL[[s]] <- df
# -------------------------------------------
# Method 3: degree heating week
# -------------------------------------------
# for each week, sum temperature that is >20 C
# plot these time series for each site
dhwL <- as.list(rep(NA,length=length(site_vector)))
names(dhwL) <- site_vector
for(s in 1:length(site_vector)){
d <- bottomall_stress[bottomall_stress$Site==site_vector[s],]
# how many weeks are there? rounding down
df <- data.frame(site = rep(site_vector[s],length=floor(length(d[,1])/7)),
weeknum = seq(from=1,to=floor(length(d[,1])/7),by=1),
startdate = seq(from=d$Date[1],to=d$Date[7*floor(length(d[,1])/7)-6],by=7),
enddate = seq(from=d$Date[7],to=d$Date[7*floor(length(d[,1])/7)],by=7),
dhw = rep(NA,length=floor(length(d[,1])/7))  )
for(i in 1:length(df$weeknum)){ #step through dates
# subset temp data to window
tsub <- d[d$Date >= df$startdate[i] & d$Date <= df$enddate[i],]
df$dhw[i] <- sum(tsub$Temperature_20)
}
dhwL[[s]] <- df
rm(tsub,df)
}
s
site_vector
site_vector[9]
s=9
d <- bottomall_stress[bottomall_stress$Site==site_vector[s],]
# how many weeks are there? rounding down
df <- data.frame(site = rep(site_vector[s],length=floor(length(d[,1])/7)),
weeknum = seq(from=1,to=floor(length(d[,1])/7),by=1),
startdate = seq(from=d$Date[1],to=d$Date[7*floor(length(d[,1])/7)-6],by=7),
enddate = seq(from=d$Date[7],to=d$Date[7*floor(length(d[,1])/7)],by=7),
dhw = rep(NA,length=floor(length(d[,1])/7))  )
floor(length(d[,1])/7)
d <- bottomall_stress[bottomall_stress$Site==site_vector[s],]
rm(tsub,df,d)
d <- bottomall_stress[bottomall_stress$Site==site_vector[s],]
length(d[,1])
length(d[,1])/7
floor(length(d[,1])/7))
floor(length(d[,1])/7)
rep(site_vector[s],length=floor(length(d[,1])/7))
seq(from=1,to=floor(length(d[,1])/7),by=1)
seq(from=d$Date[1],to=d$Date[7*floor(length(d[,1])/7)-6],by=7)
seq(from=d$Date[7],to=d$Date[7*floor(length(d[,1])/7)],by=7)
rep(NA,length=floor(length(d[,1])/7))
# how many weeks are there? rounding down
df <- data.frame(site = rep(site_vector[s],length=floor(length(d[,1])/7)),
weeknum = seq(from=1,to=floor(length(d[,1])/7),by=1),
startdate = seq(from=d$Date[1],to=d$Date[7*floor(length(d[,1])/7)-6],by=7),
enddate = seq(from=d$Date[7],to=d$Date[7*floor(length(d[,1])/7)],by=7),
dhw = rep(NA,length=floor(length(d[,1])/7))  )
length(rep(site_vector[s],length=floor(length(d[,1])/7)))
site = rep(site_vector[s],length=floor(length(d[,1])/7))
weeknum = seq(from=1,to=floor(length(d[,1])/7),by=1)
startdate = seq(from=d$Date[1],to=d$Date[7*floor(length(d[,1])/7)-6],by=7)
enddate = seq(from=d$Date[7],to=d$Date[7*floor(length(d[,1])/7)],by=7)
dhw = rep(NA,length=floor(length(d[,1])/7))
length(site)
length(weeknum)
length(startdate)
length(enddate)
length(dhw)
d$Date[7]
d$Date[7*floor(length(d[,1])/7)]
tail(d)
# how many weeks are there? rounding down
df <- data.frame(site = rep(site_vector[s],length=floor(length(d[,1])/6)),
weeknum = seq(from=1,to=floor(length(d[,1])/6),by=1),
startdate = seq(from=d$Date[1],to=d$Date[6*floor(length(d[,1])/6)-5],by=6),
enddate = seq(from=d$Date[6],to=d$Date[6*floor(length(d[,1])/6)],by=6),
dhw = rep(NA,length=floor(length(d[,1])/6))  )
rm(site,weeknum,startdate,enddate,dhw)
# -------------------------------------------
# Method 3: degree heating week
# -------------------------------------------
# for each week, sum temperature that is >20 C
# plot these time series for each site
dhwL <- as.list(rep(NA,length=length(site_vector)))
names(dhwL) <- site_vector
for(s in 1:length(site_vector)){
d <- bottomall_stress[bottomall_stress$Site==site_vector[s],]
# how many weeks are there? rounding down
df <- data.frame(site = rep(site_vector[s],length=floor(length(d[,1])/6)),
weeknum = seq(from=1,to=floor(length(d[,1])/6),by=1),
startdate = seq(from=d$Date[1],to=d$Date[6*floor(length(d[,1])/6)-5],by=6),
enddate = seq(from=d$Date[6],to=d$Date[6*floor(length(d[,1])/6)],by=6),
dhw = rep(NA,length=floor(length(d[,1])/6))  )
for(i in 1:length(df$weeknum)){ #step through dates
# subset temp data to window
tsub <- d[d$Date >= df$startdate[i] & d$Date <= df$enddate[i],]
df$dhw[i] <- sum(tsub$Temperature_20)
}
dhwL[[s]] <- df
rm(tsub,df,d)
}
s
site_vector[14]
# -------------------------------------------
# Method 3: degree heating week
# -------------------------------------------
# for each week, sum temperature that is >20 C
# plot these time series for each site
dhwL <- as.list(rep(NA,length=length(site_vector)))
names(dhwL) <- site_vector
for(s in 1:length(site_vector)){
d <- bottomall_stress[bottomall_stress$Site==site_vector[s],]
# how many weeks are there? rounding down
df <- data.frame(site = rep(site_vector[s],length=floor(length(d[,1])/5)),
weeknum = seq(from=1,to=floor(length(d[,1])/5),by=1),
startdate = seq(from=d$Date[1],to=d$Date[5*floor(length(d[,1])/5)-4],by=5),
enddate = seq(from=d$Date[5],to=d$Date[5*floor(length(d[,1])/5)],by=5),
dhw = rep(NA,length=floor(length(d[,1])/5))  )
for(i in 1:length(df$weeknum)){ #step through dates
# subset temp data to window
tsub <- d[d$Date >= df$startdate[i] & d$Date <= df$enddate[i],]
df$dhw[i] <- sum(tsub$Temperature_20)
}
dhwL[[s]] <- df
rm(tsub,df,d)
}
s
window_length = 8
# -------------------------------------------
# Method 3: degree heating week
# -------------------------------------------
# for each week, sum temperature that is >20 C
# plot these time series for each site
dhwL <- as.list(rep(NA,length=length(site_vector)))
names(dhwL) <- site_vector
window_length = 8
for(s in 1:length(site_vector)){
d <- bottomall_stress[bottomall_stress$Site==site_vector[s],]
# how many weeks are there? rounding down
df <- data.frame(site = rep(site_vector[s],length=floor(length(d[,1])/window_length)),
weeknum = seq(from=1,to=floor(length(d[,1])/window_length),by=1),
startdate = seq(from=d$Date[1],to=d$Date[window_length*floor(length(d[,1])/window_length)-(window_length-1)],by=window_length),
enddate = seq(from=d$Date[window_length],to=d$Date[window_length*floor(length(d[,1])/window_length)],by=window_length),
dhw = rep(NA,length=floor(length(d[,1])/window_length))  )
for(i in 1:length(df$weeknum)){ #step through dates
# subset temp data to window
tsub <- d[d$Date >= df$startdate[i] & d$Date <= df$enddate[i],]
df$dhw[i] <- sum(tsub$Temperature_20)
}
dhwL[[s]] <- df
rm(tsub,df,d)
}
dhw_df <- do.call('rbind',dhwL)
head(dhw_df)
summary(dhw_df)
p <- as.list(rep(NA,length=length(site_vector)))
for(s in 1:length(site_vector)){
d <- dhw_df[dhw_df$Site == site_vector[s],]
p[[s]] <- ggplot(data=d) +
#geom_point(aes(x=Date,y=Temperature)) +
geom_line(aes(x=enddate,y=dhw)) +
ggtitle(paste(site_vector[s])) +
ylab("DHW (8 day window)") + xlab("date") +
ylim(0,210) +
theme_bw()
}
p[[1]]
head(dhw_df)
p <- as.list(rep(NA,length=length(site_vector)))
for(s in 1:length(site_vector)){
d <- dhw_df[dhw_df$site == site_vector[s],]
p[[s]] <- ggplot(data=d) +
#geom_point(aes(x=Date,y=Temperature)) +
geom_line(aes(x=enddate,y=dhw)) +
ggtitle(paste(site_vector[s])) +
ylab("DHW (8 day window)") + xlab("date") +
ylim(0,210) +
theme_bw()
}
p[[1]]
